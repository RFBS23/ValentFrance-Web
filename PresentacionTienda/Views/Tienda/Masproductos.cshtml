
@{
    ViewBag.Title = "Masproductos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="filter container section">
    <h3 class="section__title"><span>Filtros</span></h3>
    <div class="filtros__container">
        <div class="single-widget">
            <select class="form-select custom-select" id="select_categoria">
                <option value="0">Todos</option>
            </select>
        </div>
        <div class="single-widget">
            <select class="form-select custom-select" id="select_marcas">
                <option value="0">Todos</option>
            </select>
        </div>
        <div class="single-widget">
            <select class="form-select custom-select" id="select_tallas">
                <option value="0">Todos</option>
            </select>
        </div>
        <button type="button" class="btn" style="cursor: pointer;" id="btn_aplicarfiltro">Aplicar Filtros</button>
    </div>
</section>

<section class="products section--lg container">
    <h3 class="section__title"><span>Todos lo</span>s Productos</h3>
    <p class="total__products">Se han encontrado <span>0</span> productos</p>
    <div class="products__container grid" id="container_productos">

    </div>

    <ul class="pagination">
        <li><a href="#" class="pagination__link active">01</a></li>
        <li><a href="#" class="pagination__link">02</a></li>
        <li><a href="#" class="pagination__link">...</a></li>
        <li><a href="#" class="pagination__link">06</a></li>
        <li>
            <a href="#" class="pagination__link icon">
                <i class="fi-rs-angle-double-small-right"></i>
            </a>
        </li>
    </ul>
</section>


@section scripts {

    <script>
        $("select").select2({
            allowClear: true,
            language: "es"
        });

        function changeImage(newSrc) {
            document.getElementById("mainImage").src = newSrc;
        }

        $(document).ready(function () {
            listarCategorias();
            listarMarcas();
            mostrarFiltros(0, 0, 0);
        })

        function listarCategorias() {
            jQuery.ajax({
                url: "@Url.Action("ListaCategorias", "Tienda")",
                type: "GET",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    $("#select_categoria").LoadingOverlay("hide");
                    $("#select_categoria").empty();
                    $("#select_categoria").append($("<option>").attr("value", "0").text("Todos"));
                    $.each(response.data, function (i, element) {
                        $("#select_categoria").append($("<option>").attr("value", element.idcategoria).text(element.nombrecategoria));
                    });
                    mostrarTallas();
                },
                beforeSend: function () {
                    $("#select_categoria").LoadingOverlay("show");
                }
            });
        }

        function listarMarcas() {
            jQuery.ajax({
                url: "@Url.Action("FiltroMarca", "Tienda")",
                type: "GET",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    $("#select_marcas").LoadingOverlay("hide");
                    $("#select_marcas").empty();
                    $("#select_marcas").append($("<option>").attr("value", "0").text("Todos"));
                    $.each(response.data, function (i, element) {
                        $("#select_marcas").append($("<option>").attr("value", element.idmarca).text(element.nombremarca));
                    });
                },
                beforeSend: function () {
                    $("#select_marcas").LoadingOverlay("show");
                },
                error: function (xhr, status, error) {
                    console.error("Error en la llamada AJAX: ", status, error);
                }
            });
        }

        function mostrarTallas() {
            var _idcategoria = $("#select_categoria").val();
            jQuery.ajax({
                url: "@Url.Action("FiltroTallas", "Tienda")",
                type: "POST",
                data: JSON.stringify({ idcategoria: _idcategoria }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    $("#select_tallas").empty();
                    $("#select_tallas").append($("<option>").attr("value", "0").text("Todos"));
                    $.each(response.data, function (i, element) {
                        $("#select_tallas").append($("<option>").attr("value", element.idtallaropa).text(element.nombretalla));
                    });
                },
                beforeSend: function () {
                    //$("#select_tallas").LoadingOverlay("show");
                }
            });
        }

        $(document).on("change", "input[name=categoria]", function () {
            mostrarTallas();
        })

        function mostrarFiltros(_idcategoria, _idmarca, _idtallaropa, page = 1, pageSize = 12) {
            jQuery.ajax({
                url: "@Url.Action("listarProductos", "Tienda")",
                type: "POST",
                data: JSON.stringify({
                    idcategoria: _idcategoria,
                    idmarca: _idmarca,
                    idtallaropa: _idtallaropa,
                    page: page,
                    pageSize: pageSize
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                beforeSend: function () {
                    $("#container_productos").LoadingOverlay("show");
                },
                success: function (response) {
                    $("#container_productos").LoadingOverlay("hide");
                    $("#container_productos").empty();

                    $(".total__products span").text(response.totalItems);

                    if (response.data.length === 0) {
                        $("<section>").addClass("section error-404 min-vh-100 d-flex flex-column align-items-center justify-content-center").append(
                            $("<h2>").addClass("text-center").text("Error al encontrar los productos"),
                            $("<h5>").addClass("text-center").text("El producto que estás buscando no existe")
                        ).appendTo("#container_productos");
                    } else {
                        $.each(response.data, function (i, element) {
                            var imagenSrc = element.Extension && element.base64
                                ? "data:image/" + element.Extension + ";base64," + element.base64
                                : "../assets/img/logovalent.png";

                            var imagenhover = element.Extension2 && element.base2
                                ? "data:image/" + element.Extension2 + ";base64," + element.base2
                                : "../assets/img/logovalent.png";

                            var precioVenta = element.precioventa;
                            var descuento = element.descuento;
                            var precioDescontado = precioVenta - (precioVenta * (descuento / 100));

                            $("<div>").addClass("product__item").append(
                                $("<div>").addClass("product__banner").append(
                                    $("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("product__images").append(
                                        $("<img>").addClass("product__img default").attr({ "src": imagenSrc }),
                                        $("<img>").addClass("product__img hover").attr({ "src": imagenhover })
                                    ),
                                    $("<div>").addClass("product__actions").append(
                                        $("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("action__btn").attr("aria-label", "Vista Rápida").append(
                                            $("<i>").addClass("fi fi-rs-eye")
                                        ),
                                        @if (Session["cliente"] != null)
                                        {
                                            @:$("<a>").attr("href", "").addClass("action__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append( $("<i>").addClass("fi fi-rs-shopping-cart") )
                                        }
                                    ),
                                    (descuento > 0) ? $("<div>").addClass("product__badge ligt-green").text("-" + descuento + " %") : null
                                ),
                                $("<div>").addClass("product__content").append(
                                    $("<span>").addClass("product__category").text(element.codigo),
                                    $("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).append(
                                        $("<h3>").addClass("product__title").text(element.nombre)
                                    ),
                                    $("<div>").addClass("product__price flex").append(
                                        (descuento > 0)
                                            ? [
                                                $("<span>").addClass("new__price").text("S/ " + precioDescontado.toFixed(2)),
                                                $("<span>").addClass("old__price").text("S/ " + precioVenta.toFixed(2)).css("text-decoration", "line-through")
                                            ]
                                            : $("<span>").addClass("new__price").text("S/ " + precioVenta.toFixed(2))
                                    ),
                                    @if (Session["cliente"] != null)
                                    {
                                        @:$("<a>").attr("href", "").addClass("action__btn cart__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append($("<i>").addClass("fi fi-rs-shopping-bag-add"))
                                    } else
                                    {
                                        @:$("<a>").attr("href", "@Url.Action("Index", "Login")").addClass("action__btn cart__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append($("<i>").addClass("fi fi-rs-shopping-bag-add"))
                                    }
                                )
                            ).appendTo("#container_productos");
                        });

                        generarPaginacion(response.totalPages, page);
                    }
                },
                complete: function () {
                    $("#container_productos").LoadingOverlay("hide");
                }
            });
        }

        $(document).ready(function () {
            $("#btn_aplicarfiltro").click(function (event) {
                event.preventDefault();

                var _idcategoria = $("#select_categoria").val();
                var _idmarca = $("#select_marcas").val();
                var _idtalla = $("#select_tallas").val();

                mostrarFiltros(_idcategoria, _idmarca, _idtalla);
            });
        });

        $(document).ready(function () {
            $("#btn_resetearfiltros").click(function () {
                mostrarFiltros(null, null, null);
                $("#select_categoria").val("");
                $("#select_marcas").val("");
                $("#select_tallas").val("");
            });
        });

        function generarPaginacion(totalPages, currentPage) {
            var pagination = $(".pagination");
            pagination.empty();

            if (totalPages > 1) {
                for (var i = 1; i <= totalPages; i++) {
                    var pageLink = $("<a>")
                        .attr("href", "#")
                        .addClass("pagination__link")
                        .text(i)
                        .on("click", function (e) {
                            e.preventDefault();
                            var page = $(this).text();
                            var _idcategoria = $("#select_categoria").val();
                            var _idmarca = $("#select_marcas").val();
                            var _idtallaropa = $("#select_tallas").val();

                            mostrarFiltros(_idcategoria, _idmarca, _idtallaropa, page);
                        });

                    if (i == currentPage) {
                        pageLink.addClass("active");
                    }

                    $("<li>").append(pageLink).appendTo(pagination);
                }
            }
        }

    </script>
}
