
@{
    ViewBag.Title = "DamasAdultas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="productos section container">

    <section class="filter container section">
        <h3 class="section__title"><span>Filtros</span></h3>
        <div class="filtros__container">
            <div class="single-widget">
                <select class="form-select custom-select" id="select_categoria" disabled style="display: none;">
                    <option value="0">Todos</option>
                </select>
            </div>
            <div class="single-widget">
                <select class="form-select custom-select" id="select_marcas">
                    <option value="0">Todos</option>
                </select>
            </div>
            <div class="single-widget">
                <select class="form-select custom-select" id="select_tallas">
                    <option value="0">Todos</option>
                </select>
            </div>
            <button type="button" class="btn" style="cursor: pointer;" id="btn_aplicarfiltro">Aplicar Filtros</button>
        </div>
    </section>

    <h3 class="section__title"><span>Categorias d</span>e dama adulta</h3>
    <div class="tab__btns">
        <span class="tab__btn active-tab" data-target="#todosDA">Todos</span>
        <span class="tab__btn" data-target="#descuentoDA">Descuento</span>
        <span class="tab__btn" data-target="#recienteDA">Nuevos</span>
    </div>

    <div class="tab__items">
        <div class="tab__item active-tab" content id="todosDA">
            <p class="total__products">Se han encontrado <span>0</span> productos</p>
            <div class="products__container grid" id="container_productosDama">
                
            </div>
        </div>

        <div class="tab__item" content id="descuentoDA">
            <p class="total_descuentos">Se han encontrado <span>0</span> productos</p>
            <div class="products__container grid" id="container_productosDescuento">

            </div>
        </div>

        <div class="tab__item" content id="recienteDA">
            <p class="total_productosnuevos">Se han encontrado <span>0</span> productos</p>
            <div class="products__container grid" id="container_productosNuevos">

            </div>
        </div>
    </div>
</section>

@section scripts {
    <script>
        $("select").select2({
            allowClear: true,
            language: "es"
        });

        function changeImage(newSrc) {
            document.getElementById("mainImage").src = newSrc;
        }

        $(document).ready(function () {
            listarCategorias();
            listarMarcas();
            mostrarFiltros(0, 0, 0);
            mostrarFiltrosDescuento(0, 0, 0);
            mostrarFiltrosNuevos(0, 0, 0);
        })

        function listarCategorias() {
            jQuery.ajax({
                url: "@Url.Action("ListaCategoriasDamas", "productoscategorias")",
                type: "GET",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    $("#select_categoria").LoadingOverlay("hide");
                    $("#select_categoria").empty();

                    // Agregar opción por defecto "Todos"
                    $("#select_categoria").append($("<option>").attr("value", "0").text("Todos"));

                    // Agregar categorías
                    $.each(response.data, function (i, element) {
                        var option = $("<option>").attr("value", element.idcategoria).text(element.nombrecategoria);

                        // Si la categoría es "damas", seleccionarla
                        if (element.nombrecategoria.toLowerCase() === "damas") {
                            option.prop("selected", true);
                        }

                        $("#select_categoria").append(option);
                    });

                    // Deshabilitar el select después de agregar las opciones
                    $("#select_categoria").prop("disabled", true);

                    mostrarTallas(); // Llamar a la función para mostrar tallas
                },
                beforeSend: function () {
                    $("#select_categoria").LoadingOverlay("show");
                }
            });
        }

        function listarMarcas() {
            jQuery.ajax({
                url: "@Url.Action("FiltroMarca", "productoscategorias")",
                type: "GET",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    $("#select_marcas").LoadingOverlay("hide");
                    $("#select_marcas").empty();
                    $("#select_marcas").append($("<option>").attr("value", "0").text("Todos"));
                    $.each(response.data, function (i, element) {
                        $("#select_marcas").append($("<option>").attr("value", element.idmarca).text(element.nombremarca));
                    });
                },
                beforeSend: function () {
                    $("#select_marcas").LoadingOverlay("show");
                },
                error: function (xhr, status, error) {
                    console.error("Error en la llamada AJAX: ", status, error);
                }
            });
        }

        function mostrarTallas() {
            var _idcategoria = $("#select_categoria").val();
            if (_idcategoria) {
                jQuery.ajax({
                    url: "@Url.Action("FiltroTallas", "productoscategorias")",
                    type: "POST",
                    data: JSON.stringify({ idcategoria: _idcategoria }),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        $("#select_tallas").empty(); // Limpiar el select de tallas
                        $("#select_tallas").append($("<option>").attr("value", "0").text("Todos")); // Opción por defecto
                        $.each(response.data, function (i, element) {
                            $("#select_tallas").append($("<option>").attr("value", element.idtallaropa).text(element.nombretalla));
                        });
                    },
                    beforeSend: function () {
                        $("#select_tallas").LoadingOverlay("show"); // Mostrar carga
                    },
                    complete: function () {
                        $("#select_tallas").LoadingOverlay("hide"); // Ocultar carga después de la respuesta
                    }
                });
            } else {
                // Si no hay categoría seleccionada, podrías limpiar las tallas o mostrar un mensaje
                $("#select_tallas").empty();
                $("#select_tallas").append($("<option>").attr("value", "0").text("Seleccione una categoría primero"));
            }
        }

        $(document).on("change", "input[name=categoria]", function () {
            mostrarTallas();
        })

        function mostrarFiltros(_idcategoria, _idmarca, _idtallaropa, page = 1, pageSize = 12) {
            jQuery.ajax({
                url: "@Url.Action("listarProductosDama", "productoscategorias")",
                type: "POST",
                data: JSON.stringify({
                    idcategoria: _idcategoria,
                    idmarca: _idmarca,
                    idtallaropa: _idtallaropa,
                    page: page,
                    pageSize: pageSize
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                beforeSend: function () {
                    $("#container_productosDama").LoadingOverlay("show");
                },
                success: function (response) {
                    $("#container_productosDama").LoadingOverlay("hide");
                    $("#container_productosDama").empty();

                    $(".total__products span").text(response.totalItems);

                    if (response.data.length === 0) {
                        $("<section>").addClass("section error-404 min-vh-100 d-flex flex-column align-items-center justify-content-center").append(
                            $("<h2>").addClass("text-center").text("Error al encontrar los productos"),
                            $("<h5>").addClass("text-center").text("El producto que estás buscando no existe")
                        ).appendTo("#container_productosDama");
                    } else {
                        $.each(response.data, function (i, element) {
                            var imagenSrc = element.Extension && element.base64
                                ? "data:image/" + element.Extension + ";base64," + element.base64
                                : "../assets/img/logovalent.png";

                            var imagenhover = element.Extension2 && element.base2
                                ? "data:image/" + element.Extension2 + ";base64," + element.base2
                                : "../assets/img/logovalent.png";

                            var precioVenta = element.precioventa;
                            var descuento = element.descuento;
                            var precioDescontado = precioVenta - (precioVenta * (descuento / 100));

                            $("<div>").addClass("product__item").append(
                                $("<div>").addClass("product__banner").append(
                                    $("<a>").attr("href", "" + element.idproducto).addClass("product__images").append(
                                        $("<img>").addClass("product__img default").attr({ "src": imagenSrc }),
                                        $("<img>").addClass("product__img hover").attr({ "src": imagenhover })
                                    ),
                                    $("<div>").addClass("product__actions").append(
                                        $("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("action__btn").attr("aria-label", "Vista Rápida").append(
                                            $("<i>").addClass("fi fi-rs-eye")
                                        ),
                                        @if (Session["cliente"] != null)
                                        {
                                            @:$("<a>").attr("href", "").addClass("action__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append( $("<i>").addClass("fi fi-rs-shopping-cart") )
                                        }
                                    ),
                                    (descuento > 0) ? $("<div>").addClass("product__badge ligt-green").text("-" + descuento + " %") : null
                                ),
                                $("<div>").addClass("product__content").append(
                                    $("<span>").addClass("product__category").text(element.codigo),
                                    $("<a>").attr("href", "").append(
                                        $("<h3>").addClass("product__title").text(element.nombre)
                                    ),
                                    $("<div>").addClass("product__price flex").append(
                                        (descuento > 0)
                                            ? [
                                                $("<span>").addClass("new__price").text("S/ " + precioDescontado.toFixed(2)),
                                                $("<span>").addClass("old__price").text("S/ " + precioVenta.toFixed(2)).css("text-decoration", "line-through")
                                            ]
                                            : $("<span>").addClass("new__price").text("S/ " + precioVenta.toFixed(2))
                                    ),
                                    @if (Session["cliente"] != null)
                                    {
                                        @:$("<a>").attr("href", "").addClass("action__btn cart__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append($("<i>").addClass("fi fi-rs-shopping-bag-add"))
                                    } else
                                    {
                                        @:$("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("action__btn cart__btn").attr("aria-label", "Vista Rápida").append($("<i>").addClass("fi fi-rs-eye"))
                                    }
                                )
                            ).appendTo("#container_productosDama");
                        });

                        generarPaginacion(response.totalPages, page);
                    }
                },
                complete: function () {
                    $("#container_productosDama").LoadingOverlay("hide");
                }
            });
        }

        /* productos con descuento */
        function mostrarFiltrosDescuento(_idcategoria, _idmarca, _idtallaropa, page = 1, pageSize = 12) {
            jQuery.ajax({
                url: "@Url.Action("listarProductosDamaDescuento", "productoscategorias")",
                type: "POST",
                data: JSON.stringify({
                    idcategoria: _idcategoria,
                    idmarca: _idmarca,
                    idtallaropa: _idtallaropa,
                    page: page,
                    pageSize: pageSize
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                beforeSend: function () {
                    $("#container_productosDescuento").LoadingOverlay("show");
                },
                success: function (response) {
                    $("#container_productosDescuento").LoadingOverlay("hide");
                    $("#container_productosDescuento").empty();

                    $(".total_descuentos span").text(response.totalItems);

                    if (response.data.length === 0) {
                        $("<section>").addClass("section error-404 min-vh-100 d-flex flex-column align-items-center justify-content-center").append(
                            $("<h2>").addClass("text-center").text("Error al encontrar los productos"),
                            $("<h5>").addClass("text-center").text("El producto que estás buscando no existe")
                        ).appendTo("#container_productosDescuento");
                    } else {
                        $.each(response.data, function (i, element) {
                            var imagenSrc = element.Extension && element.base64
                                ? "data:image/" + element.Extension + ";base64," + element.base64
                                : "../assets/img/logovalent.png";

                            var imagenhover = element.Extension2 && element.base2
                                ? "data:image/" + element.Extension2 + ";base64," + element.base2
                                : "../assets/img/logovalent.png";

                            var precioVenta = element.precioventa;
                            var descuento = element.descuento;
                            var precioDescontado = precioVenta - (precioVenta * (descuento / 100));

                            $("<div>").addClass("product__item").append(
                                $("<div>").addClass("product__banner").append(
                                    $("<a>").attr("href", "" + element.idproducto).addClass("product__images").append(
                                        $("<img>").addClass("product__img default").attr({ "src": imagenSrc }),
                                        $("<img>").addClass("product__img hover").attr({ "src": imagenhover })
                                    ),
                                    $("<div>").addClass("product__actions").append(
                                        $("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("action__btn").attr("aria-label", "Vista Rápida").append(
                                            $("<i>").addClass("fi fi-rs-eye")
                                        ),
                                        @if (Session["cliente"] != null)
                                        {
                                            @:$("<a>").attr("href", "").addClass("action__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append( $("<i>").addClass("fi fi-rs-shopping-cart") )
                                        }
                                    ),
                                    (descuento > 0) ? $("<div>").addClass("product__badge ligt-green").text("-" + descuento + " %") : null
                                ),
                                $("<div>").addClass("product__content").append(
                                    $("<span>").addClass("product__category").text(element.codigo),
                                    $("<a>").attr("href", "").append(
                                        $("<h3>").addClass("product__title").text(element.nombre)
                                    ),
                                    $("<div>").addClass("product__price flex").append(
                                        (descuento > 0)
                                            ? [
                                                $("<span>").addClass("new__price").text("S/ " + precioDescontado.toFixed(2)),
                                                $("<span>").addClass("old__price").text("S/ " + precioVenta.toFixed(2)).css("text-decoration", "line-through")
                                            ]
                                            : $("<span>").addClass("new__price").text("S/ " + precioVenta.toFixed(2))
                                    ),
                                    @if (Session["cliente"] != null)
                                    {
                                        @:$("<a>").attr("href", "").addClass("action__btn cart__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append($("<i>").addClass("fi fi-rs-shopping-bag-add"))
                                    } else
                                    {
                                        @:$("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("action__btn cart__btn").attr("aria-label", "Vista Rápida").append($("<i>").addClass("fi fi-rs-eye"))
                                    }
                                )
                            ).appendTo("#container_productosDescuento");
                        });

                        generarPaginacion(response.totalPages, page);
                    }
                },
                complete: function () {
                    $("#container_productosDescuento").LoadingOverlay("hide");
                }
            });
        }

        /* productos nuevos*/
        function mostrarFiltrosNuevos(_idcategoria, _idmarca, _idtallaropa, page = 1, pageSize = 12) {
            jQuery.ajax({
                url: "@Url.Action("listarProductosDamaNuevos", "productoscategorias")",
                type: "POST",
                data: JSON.stringify({
                    idcategoria: _idcategoria,
                    idmarca: _idmarca,
                    idtallaropa: _idtallaropa,
                    page: page,
                    pageSize: pageSize
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                beforeSend: function () {
                    $("#container_productosNuevos").LoadingOverlay("show");
                },
                success: function (response) {
                    $("#container_productosNuevos").LoadingOverlay("hide");
                    $("#container_productosNuevos").empty();

                    $(".total_productosnuevos span").text(response.totalItems);

                    if (response.data.length === 0) {
                        $("<section>").addClass("section error-404 min-vh-100 d-flex flex-column align-items-center justify-content-center").append(
                            $("<h2>").addClass("text-center").text("No se han encontrado"),
                            $("<h5>").addClass("text-center").text("Productos Nuevos")
                        ).appendTo("#container_productosNuevos");
                    } else {
                        $.each(response.data, function (i, element) {
                            var imagenSrc = element.Extension && element.base64
                                ? "data:image/" + element.Extension + ";base64," + element.base64
                                : "../assets/img/logovalent.png";

                            var imagenhover = element.Extension2 && element.base2
                                ? "data:image/" + element.Extension2 + ";base64," + element.base2
                                : "../assets/img/logovalent.png";

                            var precioVenta = element.precioventa;
                            var descuento = element.descuento;
                            var precioDescontado = precioVenta - (precioVenta * (descuento / 100));

                            $("<div>").addClass("product__item").append(
                                $("<div>").addClass("product__banner").append(
                                    $("<a>").attr("href", "" + element.idproducto).addClass("product__images").append(
                                        $("<img>").addClass("product__img default").attr({ "src": imagenSrc }),
                                        $("<img>").addClass("product__img hover").attr({ "src": imagenhover })
                                    ),
                                    $("<div>").addClass("product__actions").append(
                                        $("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("action__btn").attr("aria-label", "Vista Rápida").append(
                                            $("<i>").addClass("fi fi-rs-eye")
                                        ),
                                        @if (Session["cliente"] != null)
                                        {
                                            @:$("<a>").attr("href", "").addClass("action__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append( $("<i>").addClass("fi fi-rs-shopping-cart") )
                                        }
                                    ),
                                    (descuento > 0) ? $("<div>").addClass("product__badge ligt-orange").text("Nuevo -" + descuento + " %") : null
                                ),
                                $("<div>").addClass("product__content").append(
                                    $("<span>").addClass("product__category").text(element.codigo),
                                    $("<a>").attr("href", "").append(
                                        $("<h3>").addClass("product__title").text(element.nombre)
                                    ),
                                    $("<div>").addClass("product__price flex").append(
                                        (descuento > 0)
                                            ? [
                                                $("<span>").addClass("new__price").text("S/ " + precioDescontado.toFixed(2)),
                                                $("<span>").addClass("old__price").text("S/ " + precioVenta.toFixed(2)).css("text-decoration", "line-through")
                                            ]
                                            : $("<span>").addClass("new__price").text("S/ " + precioVenta.toFixed(2))
                                    ),
                                    @if (Session["cliente"] != null)
                                    {
                                        @:$("<a>").attr("href", "").addClass("action__btn cart__btn agregarcarrito").attr("aria-label", "Agregar al carrito").append($("<i>").addClass("fi fi-rs-shopping-bag-add"))
                                    } else
                                    {
                                        @:$("<a>").attr("href", "@Url.Action("DetalleProducto", "Tienda")" + "?idproducto=" + element.idproducto).addClass("action__btn cart__btn").attr("aria-label", "Vista Rápida").append($("<i>").addClass("fi fi-rs-eye"))
                                    }
                                )
                            ).appendTo("#container_productosNuevos");
                        });

                        generarPaginacion(response.totalPages, page);
                    }
                },
                complete: function () {
                    $("#container_productosNuevos").LoadingOverlay("hide");
                }
            });
        }

        $(document).ready(function () {
            $("#btn_aplicarfiltro").click(function (event) {
                event.preventDefault();

                var _idcategoria = $("#select_categoria").val();
                var _idmarca = $("#select_marcas").val();
                var _idtalla = $("#select_tallas").val();

                mostrarFiltros(_idcategoria, _idmarca, _idtalla);
                mostrarFiltrosDescuento(_idcategoria, _idmarca, _idtalla);
                mostrarFiltrosNuevos(_idcategoria, _idmarca, _idtalla);
            });
        });

        function generarPaginacion(totalPages, currentPage) {
            var pagination = $(".pagination");
            pagination.empty();

            if (totalPages > 1) {
                for (var i = 1; i <= totalPages; i++) {
                    var pageLink = $("<a>")
                        .attr("href", "#")
                        .addClass("pagination__link")
                        .text(i)
                        .on("click", function (e) {
                            e.preventDefault();
                            var page = $(this).text();
                            var _idcategoria = $("#select_categoria").val();
                            var _idmarca = $("#select_marcas").val();
                            var _idtallaropa = $("#select_tallas").val();

                            mostrarFiltros(_idcategoria, _idmarca, _idtallaropa, page);
                            mostrarFiltrosDescuento(_idcategoria, _idmarca, _idtallaropa, page);
                            mostrarFiltrosNuevos(_idcategoria, _idmarca, _idtallaropa, page);
                        });

                    if (i == currentPage) {
                        pageLink.addClass("active");
                    }

                    $("<li>").append(pageLink).appendTo(pagination);
                }
            }
        }
    </script>
}